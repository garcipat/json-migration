name: CI

on:
    push:
        paths:
            - 'src/**'
            - '.github/**'
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        defaults:
            run: 
                working-directory: ./src
        steps:
            - uses: actions/checkout@v4

            - name: Setup dotnet 9.x.x
              uses: actions/setup-dotnet@v4
              with: 
                dotnet-version: 9.x.x

            - name: restore
              run: dotnet restore

            - name: build
              run: dotnet build --no-restore

            - name: test with coverage
              run: dotnet test JsonMigration.Tests/JsonMigration.Tests.csproj --no-build --collect:"XPlat Code Coverage"

            - name: Install ReportGenerator
              run: dotnet tool install --global dotnet-reportgenerator-globaltool

            - name: Generate coverage report
              run: |
                reportgenerator -reports:JsonMigration.Tests/TestResults/*/coverage.cobertura.xml -targetdir:coverage-report -reporttypes:Html

            - name: Upload coverage report artifact
              uses: actions/upload-artifact@v4
              with:
                name: coverage-report
                path: src/coverage-report
